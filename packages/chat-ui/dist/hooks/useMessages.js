import{PublicKey as e}from"@solana/web3.js";import{ChatSdk as t,MessageType as r}from"@strata-foundation/chat";import{useEndpoint as a,useTransactions as n,usePublicKey as s,truthy as i}from"@strata-foundation/react";import o from"bn.js";import{useState as c,useEffect as m,useMemo as d,useCallback as l}from"react";import{useAsyncCallback as p,useAsync as g}from"react-async-hook";import{useChatSdk as f}from"../contexts/chatSdk.js";import{useChat as u}from"./useChat.js";const h={};async function w(e,t,r=[]){if(e&&t){const a=new Set(Array.from(r.filter((e=>e.meta?.err)).map((e=>e.signature)))),n=(await Promise.all(r.map((async({signature:r,transaction:a,pending:n,meta:s,blockTime:i})=>{if(!h[r]||h[r][0].pending&&!n)try{const o=(await t.getMessagePartsFromInflatedTx({transaction:a,txid:r,meta:s,blockTime:i,chat:e})).map((e=>({...e,pending:n})));h[r]=o}catch(e){console.warn("Failed to decode message",e)}return h[r]})))).flat().filter(i);return[...await t.getMessagesFromParts(n)].filter((e=>e.txids.every((e=>!a.has(e))))).map((e=>(e.pending=e.parts.some((e=>e.pending)),e)))}return[]}let y={};const b=(e,t,r)=>{const a=t.pending&&r.pending;if(r.complete)return r.pending!=a?{...r,pending:a}:r;if(t.complete)return t.pending=a,t.pending!=a?{...t,pending:a}:t;if(0==(n=new Set(t.txids),s=new Set(r.txids),new Set(Array.from(n).filter((e=>!s.has(e))))).size)return t.pending,r;var n,s;const i=new Set,o=t.parts.concat(...r.parts),c=new Set(o.filter((e=>!e.pending)).map((e=>e.txid)));return e.getMessageFromParts(o.filter((e=>(!e.pending||!c.has(e.txid))&&(!i.has(e.txid)&&(i.add(e.txid),!0)))))},M=(e,t,r)=>r.reduce(((t,r)=>{const a=t[r.id];return t[r.id]=a?b(e,r,a):r,t}),{...t}),T="https://prod-api.teamwumbo.com/messages",k=async t=>{const r=await fetch("https://prod-api.teamwumbo.com/messages",{body:JSON.stringify(t),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}});return(await r.json()).map((t=>({...t,blockTime:Number(t.blocktime),readPermissionAmount:new o(t.readPermissionAmount),readPermissionKey:new e(t.readPermissionKey),sender:new e(t.sender),signer:new e(t.signer),chat:new e(t.chat),pending:!1,totalParts:Number(t.totalParts),currentPart:Number(t.currentPart)})))};function P({chat:e,accelerated:i,numTransactions:o=50,fetcher:h}){const{chatSdk:b}=f();void 0===i&&(i=!0);const{info:T}=u(e),{cluster:P}=a();let x=!!h;"mainnet-beta"===P&&(T?.postMessageProgramId.equals(t.ID)||h)&&void 0===h&&(x=!0,h=k);const[B,I]=c({}),{transactions:j,loadingInitial:S,...v}=n({address:e,numTransactions:o,subscribe:!0,lazy:!0,accelerated:i}),N=s(e?.toBase58());m((()=>{N&&I((e=>Object.fromEntries(Object.entries(e).filter((e=>e[1].chatKey&&e[1].chatKey.equals(N))))))}),[N]);const O=d((()=>Date.now()/1e3),[]),A=d((()=>{if(e)return{chat:e.toBase58(),minBlockTime:0,maxBlockTime:O,offset:0,limit:o}}),[O,e,o]),F=l((async e=>h?h(e):Promise.resolve([])),[h]),{loading:K,result:D,error:R,execute:q}=p(F);m((()=>{b&&D&&I((e=>{const t=b.getMessagesFromParts(D);return M(b,e,t)}))}),[D,b]);const{result:z,loading:C,error:E}=g(w,[N,b,j]);m((()=>{b&&z&&I((e=>M(b,e,z)))}),[z,b]),m((()=>{A&&x?q(A):N&&!x&&T&&v.fetchMore(o)}),[T,o,x,q,A,v.fetchMore,N]);const J=d((()=>Object.values(B).sort(((e,t)=>t.startBlockTime-e.startBlockTime))),[B]),G=d((()=>{if(!J)return;const t=J.reduce(((e,t)=>(t&&t.type===r.React&&t.referenceMessageId&&(e[t.referenceMessageId]||(e[t.referenceMessageId]=[]),e[t.referenceMessageId].push(t)),e)),{}),a=J.reduce(((e,t)=>(t&&t.type!==r.React&&(e[t.id]||(e[t.id]=t)),e)),{});let n={};return e&&(y[e.toBase58()]=y[e.toBase58()]||{},n=y[e.toBase58()]),J.filter((e=>e.type!==r.React)).map((e=>(n[e.id]=n[e.id]||[],n[e.id].length!=t[e.id]?.length&&(n[e.id]=t[e.id]),{...e,reacts:n[e.id],reply:e.referenceMessageId?a[e.referenceMessageId]:null})))}),[N,J]);return{...v,hasMore:Boolean(x?J.length>0&&D&&D.length>=o:v.hasMore),fetchMore:x?async e=>{await q({...A,limit:e,maxBlockTime:D&&D[D.length-1]&&D[D.length-1].blockTime})}:v.fetchMore,fetchNew:x?async e=>{await q({...A,limit:e,maxBlockTime:(new Date).valueOf()/1e3,minBlockTime:D&&D[0]?D[0].blockTime:0})}:v.fetchNew,loadingInitial:S||x&&!D&&!K,loadingMore:C||K||v.loadingMore,error:v.error||E||R,messages:G}}export{T as MESSAGE_LAMBDA,P as useMessages};
//# sourceMappingURL=useMessages.js.map
