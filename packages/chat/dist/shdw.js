import{__awaiter as e}from"./node_modules/tslib/tslib.es6.js";import{getOrca as t,OrcaPoolConfig as n}from"@orca-so/sdk";import{AnchorProvider as o}from"@project-serum/anchor";import{ShdwDrive as i}from"@shadow-drive/sdk";import{Token as r,ASSOCIATED_TOKEN_PROGRAM_ID as c,TOKEN_PROGRAM_ID as l,u64 as s,AccountLayout as a}from"@solana/spl-token";import{PublicKey as u,Keypair as d,Connection as f}from"@solana/web3.js";import{truthy as p,sendAndConfirmWithRetry as y,sleep as m,getMintInfo as g,toNumber as h}from"@strata-foundation/spl-utils";import w from"bn.js";import v from"decimal.js";class b{constructor(e){this.payer=e}signTransaction(t){return e(this,void 0,void 0,(function*(){return t.partialSign(this.payer),t}))}signAllTransactions(t){return e(this,void 0,void 0,(function*(){return t.map((e=>(e.partialSign(this.payer),e)))}))}get publicKey(){return this.payer.publicKey}}const A=new u("2e1wdyNhUvE76y6yUCvah2KaviavMJYKoRun8acMRBZZ"),S=new u("SHDWyBxihqiCj6YekG2GUr7wqKLeLAMK1gHZck9pL6y");function k(e,t){return u.findProgramAddress([Buffer.from("storage-account"),e.toBytes(),t.toTwos(2).toArrayLike(Buffer,"le",4)],A)}function K(e){const t=e._rpcEndpoint;return t.includes("dev")?"https://ssc-dao.genesysgo.net":t}function B(u,d,A){var B;return e(this,void 0,void 0,(function*(){if(0!=A&&u){d=N(null==u?void 0:u.connection,d);const x=new f(K(u.connection),"max"),E=new o(x,d?new b(d):u.wallet,{}),M=d?d.publicKey:u.wallet.publicKey,$=new i(E.connection,E.wallet),[L]=yield k(M,new w(0));let O;try{O=yield $.getStorageAccount(L)}catch(e){}let T=0;const U=O&&Number(O.reserved_bytes)-Number(O.current_usage),_=U&&U>A;if(_)O||(T=Math.ceil(2*A/1024));else{let e=Number(U||2*A);for(;e<A;)e+=e;T=Math.ceil(e/1024)}console.log(`Storage currently has ${Number(U||0)}, file size is ${A}, adding ${T} KB`);const H=(_?0:Math.max(1024*T,1))/Math.pow(10,9),P=yield function(t,n,o){return e(this,void 0,void 0,(function*(){const e=yield r.getAssociatedTokenAddress(c,l,o,n,!0),i=yield g(t,o),u=yield t.connection.getAccountInfo(e,"confirmed");return u?h(s.fromBuffer(a.decode(u.data).amount),i):0}))}(E,M,S),D=null===(B=yield x.getAccountInfo(M))||void 0===B?void 0:B.lamports;if(P<H){if(!D)throw new Error("Not enough sol in wallet "+M.toBase58());const e=t(E.connection).getPool(n.SHDW_SOL),o=e.getTokenB(),i=e.getTokenA(),r=yield e.getQuote(i,new v(1.5*H));if(console.log(`Not enough SHDW, buying ${H} SHDW for ~${r.getExpectedOutputAmount().toNumber()} SOL`),r.getExpectedOutputAmount().toU64().gte(new w(D)))throw new Error("Not enough sol");const c=yield e.swap(M,o,r.getExpectedOutputAmount(),new v(H)),l=c.transaction;l.recentBlockhash=(yield E.connection.getRecentBlockhash()).blockhash,l.feePayer=M;const s=[...c.signers,d].filter(p);l.sign(...s),yield y(E.connection,l.serialize(),{skipPreflight:!0},"max"),yield m(2e3)}yield $.init(),O&&T&&!_?yield j((()=>$.addStorage(L,T+"KB","v2")),3):O||(yield j((()=>$.createStorageAccount("chat",T+"KB","v2")),3),yield j((()=>$.makeStorageImmutable(L,"v2")),3))}}))}function x(t,n,o,r=5){return e(this,void 0,void 0,(function*(){if(0==n.length)return[];const c=n.reduce(((e,t)=>e+t.size),0);if(yield B(t,o,c),t){const c=(o=N(t.connection,o))?o.publicKey:t.wallet.publicKey,[l]=yield k(c,new w(0)),s=new i(new f(K(t.connection),"max"),o?new b(o):t.wallet);yield s.init();return yield j((()=>e(this,void 0,void 0,(function*(){const e=(yield s.uploadMultipleFiles(l,n)).map((e=>e.location));if(e.length!==n.length)throw new Error("Upload failed");return e}))),r)}}))}function E(e){const t=e.name.split(".").pop(),n=Math.random().toString(32).slice(2)+(t?`.${t}`:"");Object.defineProperty(e,"name",{writable:!0,value:n})}const M=d.fromSecretKey(new Uint8Array([17,83,103,136,230,98,37,214,218,31,168,218,184,30,163,18,164,101,117,232,151,205,200,74,198,52,31,21,234,238,220,182,9,99,203,242,226,192,165,246,188,184,61,204,50,228,30,89,215,145,146,206,179,116,224,158,180,176,27,221,238,77,69,207]));function N(e,t){return e._rpcEndpoint.includes("dev")?M:t}function j(t,n=3){return e(this,void 0,void 0,(function*(){try{return yield t()}catch(e){if(n>0)return console.warn(`Failed tx, retrying up to ${n} more times.`,e),yield m(1e3),j(t,n-1);throw e}}))}export{b as default,B as initStorageIfNeeded,E as randomizeFileName,x as uploadFiles};
//# sourceMappingURL=shdw.js.map
